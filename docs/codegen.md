---
layout: default
title: Code Generator
permalink: /docs/codegen/
---

A Java representation of an application's test specification can be generated by using `proctor-codegen` module. A concrete implementation of `AbstractGroups` and `AbstractGroupsManager` will be generated.

**AbstractGroups** -
Provides an interface for consuming and accessing the groups for a user. Accessor methods are generated for each test and testbucket.

**AbstractGroupsManager** -
Provides an interface for determining the groups for a user based on the provided `Identifiers` and `context`.

### Example specification

Consider the following [ExampleGroups.json](https://gist.github.com/parker/3bb0e94b9b238b48429f#file-2-examplegroups-context-json) specification

```javascript
{
    "tests" : {
        "bgcolortst": {
            "buckets": {
                "inactive":-1,
                "altcolor1":0,
                "altcolor2":1,
                "altcolor3":2,
                "altcolor4":3
            },
            "fallbackValue": -1
        }
    },
    "providedContext": {
        "country": "String",
        "loggedIn": "boolean",
        "language": "String",
        "ua": "com.indeed.example.UserAgent"
    }
}
```

### Generated ExampleGroupsManager.java

```java
package com.indeed.example;

public class ExampleGroupsManager extends AbstractGroupsManager {
  public ExampleGroupsManager(final Supplier<Proctor> proctorSource) {
      super(proctorSource);
  }

  public ProctorResult determineBuckets(final Identifiers identifiers,
                                        final String country,
                                        final boolean loggedIn,
                                        final String language,
                                        final com.indeed.example.UserAgent ua);
                              
  public ProctorResult determineBuckets(final HttpServletRequest request, 
                                        final HttpServletResponse response,
                                        final Identifiers identifiers, 
                                        final boolean allowForcedGroups,
                                        final String country,
                                        final boolean loggedIn,
                                        final String language,
                                        final com.indeed.example.UserAgent ua);
}
```
key points:

- The `Supplier<Proctor> proctorSource` constructor argument should provide a loaded Proctor instance. Typically, this is an implementation of `AbstractProctorLoader`. See [proctor-loader][Loader] for more details.
- The `determineBuckets` method signature contains context variables as defined in the `providedContext`. These automatically get mapped to their corresponding variable names in the context mapping.
- `ProctorResult` encapsulates the collection of test-buckets identified for each test in an application's specification. The `ProctorResult` is a thin wrapper around a map from `testName => TestBucket`. This map will only contain tests that satisfy all of the following:
  - The `Identifiers` contain an value for the test's `test-type`. If a test-type is `RANDOM`, it will only be included if `Identifiers.randomEnabled` is `true'`
  - A test's `eligibility-rule` must have evaluated to `true`.
  - The test-matrix must contain a valid `test-definition` for the test.

### Generated ExampleGroups.java

```java
package com.indeed.example;

public class ExampleGroups extends AbstractGroups {
    public static final ExampleGroups EMPTY = new ExampleGroups(ProctorResult.EMPTY);

    public ExampleGroups(final ProctorResult proctorResult) {
        super(proctorResult);
    }

    public enum Test {
        BGCOLORTST("bgcolortst");
    }
    
    public enum Bgcolortst implements Bucket<Test> {
            INACTIVE(-1, "inactive"),
            ALTCOLOR1(0, "altcolor1"),
            ALTCOLOR2(1, "altcolor2"),
            ALTCOLOR3(2, "altcolor3"),
            ALTCOLOR4(3, "altcolor4");    
    }
    
    public Bgcolortst getBgcolortst();
    public int getBgcolortstValue(final int defaultValue);
    
    public boolean isBgcolortstInactive();
    public boolean isBgcolortstAltcolor1();
    public boolean isBgcolortstAltcolor2();
    public boolean isBgcolortstAltcolor3();
    public boolean isBgcolortstAltcolor4();
}
```

key points

- `AbstractGroups` provide a application-specific meaning to each test and test-bucket.
- An `enum` is created for each `test` and corresponding `group`
- Accessors for each test `group` are generated and can be used to check if a proctor-result contains the specified `test bucket`.


## <a name="maven"></a>proctor-maven-plugin
The `proctor-maven-plugin` plugin makes it easy to incorporate Java code generation into the [maven build lifecycle](http://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html).

| Goal | Default Phase | Description |
| ---- | ------------- | ----------- |
| `generate` | generate-sources | Generates groups and groups-manager from `src/main/proctor` and adds specification as source resource | 
| `generate-test` | generate-test-sources | Generates groups and groups-manager from `src/test/proctor` and adds specification as test resource |

The following `plugin` element should be added to your application's `pom.xml` ([complete pom.xml example example](https://gist.github.com/parker/c0ea111ff343f58346e0#file-pom-xml)):

```xml
...
  <plugin>
    <groupId>com.indeed</groupId>
    <artifactId>proctor-maven-plugin</artifactId>
    <version>1.0-SNAPSHOT</version>
    <executions>
      <execution>
        <id>proctor-generate</id>
        <goals>
          <goal>generate</goal>
        </goals>
      </execution>
    </executions>
  </plugin>
...
```

The `generate` goal will be executed in the standard compile and build lifecycle. To man manually run the code generator, run the following in a terminal:

```bash
$ mvn com.indeed:proctor-maven-plugin:generate
```

By convention, the plugin determines the java package and classname from the specification's path and filename, respectively.

```bash
.
├── src
|   ├── main
|       ├── proctor
|           ├── org/your/company/app/ExampleGroups.json
|   ├── test
|       ├── proctor
|           ├── org/your/company/app/ExampleGroups.json
```

```bash
src/main/org/your/company/app/ExampleGroups.json 
    => org.your.company.app.ExampleGroups.java
    => org.your.company.app.ExampleGroupsManager.java
```

## <a name="ant"></a>proctor-ant-plugin
The `proctor-ant-plugin` project provides an ant task, `com.indeed.proctor.consumer.gen.ant.TestGroupsGeneratorTask`, that can be invoked during ant's build process and used to generate Java code.

[TODO: is the ant task bundled properly? Adjust ant task to use file name and package just like maven plugin?]

1. Add a _proctor_ configuration and _proctor-ant-plugin_ dependency to your application's _ivy.xml_

  ```xml
    <configurations defaultconfmapping="default->default(master)">
        <conf name="compile" extends="default"/>
        <conf name="proctor" extends="compile"/>
    </configurations>

    <dependencies>
        <dependency org="com.indeed" name="proctor-ant-plugin" 
                    rev="1.0-SNAPSHOT" conf="proctor->default" />
    </dependencies>
  ```

2. Create specification in your application's `src/resources` directory

  ```bash
    .
    ├── src
    |   ├── resources
    |       ├── org/your/company/app/ExampleGroups.json
  ```

3. Add a classpath ref for the _proctor_ configuration and define a ant target for invoking `TestGroupsGeneratorTask`. Unlike the maven plugin, the package, groups class name, and groups manager class name must be specified in the ant task. Typically, the _compile_ target depends on the _proctor-generate_ target and the generated-code (in `generated-src`) is not committed to version-control.

  ```xml
    <target name="init" description="Resolve dependencies and set classpaths">
        ...
        <ivy:cachepath pathid="proctor.path"  conf="proctor"/>
        ...
    </target>
    
    <target name="proctor-generate" depends="init" description="generates the Proctor Groups and GroupsManager for the provided specification">
        <mkdir dir="generated-src/java" />
        <taskdef name="proctor-gen" classname="com.indeed.proctor.consumer.gen.ant.TestGroupsGeneratorTask" classpathref="proctor.path" />
        <proctor-gen 
                  input="src/resources/org/your/company/app/ExampleGroups.json"
                  target="generated-src/java"
                  packageName="org.your.company.app"
                  groupsClass="ExampleGroups"
                  groupsManagerClass="ExampleGroupsManager"/>
    </target>

    <target name="compile" depends="proctor-generate">
      ...
    </target>
  ```

  See [example ivy.xml and build.xml gist](https://gist.github.com/parker/9eebd91fcb57ea416c6a) for a complete example

[Loader]: {{ site.baseurl }}/docs/loader
